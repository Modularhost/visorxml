<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor Xml SII</title>
  <style>
    body {font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7;}
    h1 {color: #333;}
    .controls {margin-bottom: 20px;}
    table {border-collapse: collapse; width: 100%; margin-top: 10px; background: #fff;}
    table, th, td {border: 1px solid #ccc;}
    th, td {padding: 8px; text-align: left;}
    pre {background: #272822; color: #f8f8f2; padding: 10px; overflow-x: auto;}
  </style>
</head>
<body>
  <h1>Visor Xml SII</h1>
  <div class="controls">
    <label>Seleccionar XML: <input type="file" id="fileInput" accept=".xml"></label>
    <label>Codificación:
      <select id="encoding">
        <option value="ISO-8859-1">ISO-8859-1</option>
        <option value="UTF-8">UTF-8</option>
      </select>
    </label>
    <button id="parseBtn">Parsear</button>
  </div>

  <div id="info"></div>
  <div id="items"></div>
  <h3>XML Formateado:</h3>
  <pre id="xmlOutput"></pre>

  <script>
    function escapeXml(unsafe) {
      return unsafe.replace(/[&<>"']/g, function(c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] || c;
      });
    }

    document.getElementById('parseBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('fileInput');
      const encoding = document.getElementById('encoding').value;
      if (!fileInput.files.length) return alert("Selecciona un archivo XML");

      const reader = new FileReader();
      reader.onload = e => {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "text/xml");

        let folioNode = xmlDoc.evaluate("//*[local-name()='Folio']", xmlDoc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        let rznSocNode = xmlDoc.evaluate("//*[local-name()='Emisor']//*[local-name()='RznSoc']", xmlDoc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        let fechaNode = xmlDoc.evaluate("//*[local-name()='Encabezado']//*[local-name()='IdDoc']//*[local-name()='FchEmis']", xmlDoc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        let totalNode = xmlDoc.evaluate("//*[local-name()='Encabezado']//*[local-name()='Totales']//*[local-name()='MntTotal']", xmlDoc, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;

        document.getElementById('info').innerHTML = `
          <p><b>Folio:</b> ${folioNode?.textContent || ''}</p>
          <p><b>RznSoc (Emisor):</b> ${rznSocNode?.textContent || ''}</p>
          <p><b>Fecha Emisión:</b> ${fechaNode?.textContent || ''}</p>
          <p><b>Total:</b> ${totalNode?.textContent || ''}</p>
        `;

        // Detalle de ítems
        let itemsNodes = xmlDoc.evaluate("//*[local-name()='Detalle']", xmlDoc, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
        let html = "<table><tr><th>NroLinDet</th><th>NmbItem</th><th>Cantidad</th><th>Precio</th><th>Monto Item</th></tr>";
        for (let i = 0; i < itemsNodes.snapshotLength; i++) {
          let node = itemsNodes.snapshotItem(i);
          let nro = node.querySelector("NroLinDet")?.textContent || "";
          let nmb = node.querySelector("NmbItem")?.textContent || "";
          let qty = node.querySelector("QtyItem")?.textContent || "";
          let qtyInt = parseFloat(qty);
          // Mostrar entero si corresponde
          let qtyDisplay = Number.isNaN(qtyInt) ? qty : (Number.isInteger(qtyInt) ? qtyInt : qtyInt.toFixed(2));

          let precio = node.querySelector("PrcItem")?.textContent || "";
          let monto = node.querySelector("MontoItem")?.textContent || "";
          html += `<tr><td>${nro}</td><td>${nmb}</td><td>${qtyDisplay}</td><td>${precio}</td><td>${monto}</td></tr>`;
        }
        html += "</table>";
        document.getElementById('items').innerHTML = html;

        // Mostrar XML formateado
        const serializer = new XMLSerializer();
        let xmlString = serializer.serializeToString(xmlDoc.documentElement);
        document.getElementById('xmlOutput').textContent = escapeXml(xmlString);
      };
      reader.readAsText(fileInput.files[0], encoding);
    });
  </script>
</body>
</html>
